---
title: "Semi-automated grading workflow"
output: html_document
editor_options: 
  markdown: 
    wrap: 80
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rio)
library(clipr)
source(here::here("R/utils-grading.R"))
source(here::here("R/utils-export.R"))
```


## Import grading information

Assumes that student info was collected from moodle via the standard form for
"Klausuranmeldung" and that the resulting sheet as exported from moodle also
contains the points (or grades) the students achieved.

**For processing further, your `results`-table needs at least the following columns:**

-   `matriculation`: "Matrikelnummer"
-   `vn`, `nn`: surname, family name
-   `po`, `anderePO`: subjects, as exported from moodle's "Klausuranmeldung"
-   `points`: achieved points  --  
    **NB:** 0 points are assumed to mean invalidated / "entwertet" or no-show  
    if you have participants that actually got 0 points, just set them to 0.1, e.g...
-   (`grade`, if not generated automatically from `points`, see below)

E.g.

```{r import}
results <- 
  rio::import("/home/fabians/lehre/stat1/attic/ex-21/Punkte-short-Matrikeln-ergÃ¤nzt.csv") 
head(results)

results <- results |> 
  select(c(Matrikelnummer, vn, nn,  po, Gesamt, `andere PO`)) |> 
  rename("matriculation" = Matrikelnummer, 
         "points" = Gesamt)
glimpse(results)
```


## Set grades

Set maximum number of points and adjust recommended grading scheme
(*Notenstufen*) if necessary:

```{r scheme}
MAX_POINTS <- 256 #! change this if you rerun for a different exam
(scheme <- set_grading_scheme(max_points = MAX_POINTS, niceness = .0))
```


Then compute grades and identify borderline cases
(skip this if your table already contains grades and not just points, but **make sure
`scheme` and `MAX_POINTS` are set correctly**):
```{r grade}
results <- results |> 
  mutate(
    grade = grade_points(points, scheme = scheme),
    # who failed by 2 pts or less?
    almost_but_no_cookie = (points < scheme[1]) & (points > (scheme[1] - 2)))
glimpse(results)

filter(results, isTRUE(almost_but_no_cookie)) # be merciful to these folks who just missed the cut-off...?
```

See `utils-grading.R` for function details.

## Summarize & publish (pseudonymous) results

`summarize_grades` and `publish_grades` both put their output on the
clipboard if you run them in `interactive()`-mode. 
These outputs are formatted as an HTML table,
so you can paste them directly into Moodle's HTML editor... :)

```{r summarize}
# without invalid / no-show exams
summarized <- 
  summarize_grades(results, scheme = scheme, max_points = MAX_POINTS, exclude_invalid = FALSE)
summarized |> knitr::kable()

# all:
summarized_all <- 
  summarize_grades(results, scheme = scheme, max_points = MAX_POINTS, exclude_invalid = FALSE)
summarized_all |> knitr::kable()
```

Pseudonymous results:

```{r publish, results='markup'}
public <- publish_grades(results, scheme = scheme, max_points = MAX_POINTS)
public |> knitr::kable()

# without no-shows / invalidated:
public_all <- results |>  filter(grade != "invalid") |> 
   publish_grades(results, scheme = scheme, max_points = MAX_POINTS)  
public:all |> knitr::kable()+
```



## Export official grade tables

### Export for *new* Statistik PO 2021

```{r export-new}
results_new <- mutate(results, 
  grade_num = as.numeric(as.character(grade)) * 100, 
  geschl = "",
  abschl = "",
  Stg = "",
  pversuch = "",
  pvermerk = "",
  email = "") |> 
  rename(mtknr = "matriculation", 
         nachname = "nn",
         vorname = "vn",
         poversion = "po",
         bewertung = "grade_num") |> 
  select(mtknr, nachname, vorname, geschl, abschl, Stg, 
         poversion, pversuch, pvermerk, bewertung, email)

results_new |> print.data.frame(row.names = FALSE, max = nrow(results_new)) |> 
  clipr::write_clip()  #put it on the clipboard, ctrl-v into the template .xls-File
```

### Export for Statistik PO 2010 etc

not automated, sorry.

### Export to Uni2Work

CS majors can get their grades from [uni2work](https://uni2work.ifi.lmu.de),
maths majors (theoretically) as well (... I think?)

![](images/paste-809C5790.png)\

```{r export-uni2work}
results_cs_maths <- filter(results, 
                           po != "Statistik als HF")
export_uni2work(results_cs_maths, outfile = "demo-uni2work.csv")
```
Then log in at [uni2work](https://uni2work.ifi.lmu.de), create an "external exam", 
navigate to its "Participants" tab & upload this CSV file. 
